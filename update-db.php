<?php
if ($argc != 2) {
    echo "Usage: php update-db.php <exploitdb_dir>\n";
    exit(1);
}

class ExploitDBUpdater {
    private $db;
    
    public function __construct($db_file) {
        $this->db = new SQLite3($db_file);
    }
    
    public function update($exploitdb_dir, $ip) {
        echo "Updating the Exploit-DB...\n";
        
        // Use Nmap to scan the IP and gather more information
        $nmap_output = shell_exec('nmap -sT -O -sV -p- ' . $ip);
        $nmap_lines = explode("\n", $nmap_output);
        
        // Parse the Nmap output to gather more information
        $ports = array();
        $os = '';
        $device_type = '';
        foreach ($nmap_lines as $line) {
            if (strpos($line, 'open') !== false) {
                $port = substr($line, 0, strpos($line, '/'));
                $ports[] = $port;
            } elseif (strpos($line, 'OS details:') !== false) {
                $os = substr($line, strpos($line, ':') + 1);
            } elseif (strpos($line, 'Device type:') !== false) {
                $device_type = substr($line, strpos($line, ':') + 1);
            }
        }
        
        // Insert the gathered information into the database
        foreach ($ports as $port) {
            $stmt = $this->db->prepare("INSERT INTO exploits (ip, port, os, device_type) VALUES (:ip, :port, :os, :device_type)");
            $stmt->bindValue(':ip', $ip, SQLITE3_TEXT);
            $stmt->bindValue(':port', $port, SQLITE3_TEXT);
            $stmt->bindValue(':os', $os, SQLITE3_TEXT);
            $stmt->bindValue(':device_type', $device_type, SQLITE3_TEXT);
            $stmt->execute();
        }
        
        echo "Update complete.\n";
    }
}

$db_file = 'exploitdb.db';
$exploitdb_dir = $argv[1];
$ip = $argv[2];

$updater = new ExploitDBUpdater($db_file);
$updater->update($exploitdb_dir, $ip);